{% extends "base.html" %}
{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3">Dashboard</h1>
    <form method="get" class="d-flex gap-2">
      <label>
        <input name="period" type="month" class="form-control form-control-sm" value="{{ period_str }}">
      </label>
      <button class="btn btn-outline-secondary btn-sm">Apply</button>
    </form>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted">Total balance</div>
          <div class="fs-4 fw-semibold">{{ total_balance }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted">Income ({{ period|date:"Y-m" }})</div>
          <div class="fs-4 fw-semibold text-success">{{ income }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted">Expenses ({{ period|date:"Y-m" }})</div>
          <div class="fs-4 fw-semibold text-danger">{{ expenses }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted">Net (inc âˆ’ exp)</div>
          <div class="fs-4 fw-semibold">{{ net }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Accounts -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Accounts</span>
          <a class="btn btn-sm btn-primary" href="{% url 'fin_mate:account-create' %}">Add</a>
        </div>
        <div class="card-body p-0">
          <table class="table align-middle mb-0">
            <thead>
              <tr><th>Name</th><th>Type</th><th>Currency</th><th class="text-end">Balance</th></tr>
            </thead>
            <tbody>
            {% for a in accounts %}
              <tr>
                <td><a href="{% url 'fin_mate:account-detail' a.pk %}">{{ a.name }}</a></td>
                <td>{{ a.get_type_display }}</td>
                <td>{{ a.currency }}</td>
                <td class="text-end">{{ a.annotated_balance }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-center text-muted">No accounts yet.</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Top categories -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">Top expense categories ({{ period|date:"Y-m" }})</div>
        <div class="card-body">
          {% if top_categories %}
            <ul class="list-group">
              {% for c in top_categories %}
                <li class="list-group-item">
                  <div class="d-flex justify-content-between align-items-center">
                    <strong>{{ c.name }}</strong>
                    <span>{{ c.total }}</span>
                  </div>
                  <div class="progress mt-2" role="progressbar" aria-valuenow="{{ c.percent|floatformat:0 }}" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar" style="width: {{ c.percent|floatformat:0 }}%">{{ c.percent|floatformat:0 }}%</div>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-muted">No expenses this month.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Budgets -->
    <div class="col-12">
      <div class="card h-100 mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Budgets ({{ period|date:"Y-m" }})</span>
          <a class="btn btn-sm btn-primary" href="{% url 'fin_mate:budget-create' %}">Add</a>
        </div>
        <div class="card-body p-0">
          <table class="table align-middle mb-0">
            <thead>
              <tr><th>Category</th><th>Limit</th><th>Spent</th><th>Progress</th><th></th></tr>
            </thead>
            <tbody>
            {% for b in budgets %}
              <tr>
                <td>{{ b.obj.category.name }}</td>
                <td>{{ b.obj.limit }}</td>
                <td>{{ b.spent }}</td>
                <td style="min-width: 220px;">
                  {% with p=b.progress|floatformat:0 %}
                    <div class="progress" role="progressbar" aria-valuenow="{{ p }}" aria-valuemin="0" aria-valuemax="100">
                      <div class="progress-bar {% if p|add:'0' > 100 %}bg-danger{% else %}bg-success{% endif %}" style="width: {{ p }}%">{{ p }}%</div>
                    </div>
                  {% endwith %}
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'fin_mate:budget-detail' b.obj.pk %}">Open</a>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-center text-muted">No budgets yet.</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Recent transactions -->
    <div class="col-12">
      <div class="card h-100 mt-3">
        <div class="card-header">Recent transactions</div>
        <div class="card-body p-0">
          <table class="table align-middle mb-0">
            <thead>
              <tr><th>Date</th><th>Type</th><th>Amount</th><th>Account</th><th>Category</th><th></th></tr>
            </thead>
            <tbody>
            {% for tx in recent %}
              <tr>
                <td>{{ tx.date|date:"Y-m-d" }}</td>
                <td>
                  {% if tx.type == 'INCOME' %}
                    <span class="badge text-bg-success">Income</span>
                  {% else %}
                    <span class="badge text-bg-danger">Expense</span>
                  {% endif %}
                </td>
                <td>{{ tx.amount }}</td>
                <td>{{ tx.account.name }}</td>
                <td>{{ tx.category.name }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'fin_mate:transaction-detail' tx.pk %}">Open</a>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="text-center text-muted">No transactions yet.</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
{% endblock %}
