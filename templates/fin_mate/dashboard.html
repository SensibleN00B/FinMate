{% extends "base.html" %}
{% load static %}
{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3 page-hero position-relative">
    <h1 class="h3 page-title">Dashboard</h1>
    <div class="d-flex gap-2">
      <form method="get" class="d-flex gap-2" role="search" aria-label="Pick month">
        <label class="visually-hidden" for="period-input">Period</label>
        <input id="period-input" name="period" type="month" class="form-control form-control-sm"
               value="{{ period_str }}"/>
        <button class="btn btn-outline-secondary btn-sm" type="submit">Apply</button>
      </form>
      <a class="btn btn-primary btn-sm" href="{% url 'fin_mate:transaction-create' %}">Add transaction</a>
      <a class="btn btn-outline-primary btn-sm" href="{% url 'fin_mate:budget-create' %}">New budget</a>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'fin_mate:account-create' %}">New account</a>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card metric-card h-100">
        <div class="card-body">
          <div class="text-muted stat-label">Total balance ({{ base_currency }})</div>
          <div class="fs-4 fw-semibold">{{ total_balance }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card metric-card h-100">
        <div class="card-body">
          <div class="text-muted stat-label">Income ({{ period|date:"Y-m" }})</div>
          <div class="fs-4 fw-semibold text-success">{{ income }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card metric-card h-100">
        <div class="card-body">
          <div class="text-muted stat-label">Expenses ({{ period|date:"Y-m" }})</div>
          <div class="fs-4 fw-semibold text-danger">{{ expenses }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card metric-card h-100">
        <div class="card-body">
          <div class="text-muted stat-label">Net (inc âˆ’ exp)</div>
          <div class="fs-4 fw-semibold">{{ net }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Accounts -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Accounts</span>
          <a class="btn btn-sm btn-primary" href="{% url 'fin_mate:account-create' %}">Add</a>
        </div>
        <div class="card-body p-0">
          <table class="table align-middle mb-0" aria-label="Accounts table">
            <thead>
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Type</th>
              <th scope="col">Currency</th>
              <th scope="col" class="text-end">Balance</th>
            </tr>
            </thead>
            <tbody>
            {% for a in accounts %}
              <tr>
                <td class="position-relative">
                  <span class="fw-semibold">{{ a.name }}</span>
                  <a class="stretched-link" href="{% url 'fin_mate:account-detail' a.pk %}"
                     aria-label="Open {{ a.name }}"></a>
                </td>
                <td>{{ a.get_type_display }}</td>
                <td>{{ a.currency }}</td>
                <td class="text-end">{{ a.annotated_balance }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted">No accounts yet.</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="card mt-3">
          <div class="card-header">Balances by account</div>
          <div class="card-body">
            <canvas id="chart_accounts" height="220" aria-label="Balances by account" role="img"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Top categories -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">Top expense categories ({{ period|date:"Y-m" }})</div>
        <div class="card-body">
          {% if top_categories %}
            <canvas id="chart_top_expenses" height="250" aria-label="Top expense categories" role="img"></canvas>
          {% else %}
            <div class="text-muted">No expenses this month.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Budgets -->
    <div class="col-12">
      <div class="card h-100 mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Budgets ({{ period|date:"Y-m" }})</span>
          <a class="btn btn-sm btn-primary" href="{% url 'fin_mate:budget-create' %}">Add</a>
        </div>
        <div class="card-body p-0">
          <table class="table align-middle mb-0" aria-label="Budgets table">
            <thead>
            <tr>
              <th scope="col">Category</th>
              <th scope="col">Limit</th>
              <th scope="col">Spent</th>
              <th scope="col">Progress</th>
              <th scope="col"></th>
            </tr>
            </thead>
            <tbody>
            {% for b in budgets %}
              <tr>
                <td>{{ b.obj.category.name }}</td>
                <td>{{ b.obj.limit }}</td>
                <td>{{ b.spent }}</td>
                <td style="min-width: 220px;">
                  {% with p=b.progress|floatformat:0 %}
                    <div class="progress" role="progressbar"
                         aria-valuenow="{{ p }}" aria-valuemin="0" aria-valuemax="100">
                      <div class="progress-bar
                         {% if p|add:'0' > 100 %}pg-red
                         {% elif p|add:'0' >= 80 %}pg-amber
                         {% else %}pg-green
                         {% endif %}"
                         style="width: {{ p }}%">
                        {{ p }}%
                      </div>
                    </div>
                  {% endwith %}

                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{% url 'fin_mate:budget-detail' b.obj.pk %}">Open</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted">No budgets yet.</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Recent transactions -->
    <div class="col-12">
      <div class="card h-100 mt-3">
        <div class="card-header">Recent transactions</div>
        <div class="card-body p-0">
          <table class="table align-middle mb-0" aria-label="Recent transactions">
            <thead>
            <tr>
              <th scope="col">Date</th>
              <th scope="col">Type</th>
              <th scope="col">Amount</th>
              <th scope="col">Account</th>
              <th scope="col">Category</th>
              <th scope="col"></th>
            </tr>
            </thead>
            <tbody>
            {% for tx in recent %}
              <tr>
                <td>{{ tx.date|date:"Y-m-d" }}</td>
                <td>
                  {% if tx.type == 'INCOME' %}
                    <span class="badge text-bg-success">Income</span>
                  {% else %}
                    <span class="badge text-bg-danger">Expense</span>
                  {% endif %}
                </td>
                <td>{{ tx.amount }}</td>
                <td>{{ tx.account.name }}</td>
                <td>{{ tx.category.name }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{% url 'fin_mate:transaction-detail' tx.pk %}">Open</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted">No transactions yet.</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <!-- Chart.js + DataLabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2" defer></script>

  {{ top_categories|json_script:"top-cats-data" }}
  {{ accounts_chart|json_script:"accounts-chart-data" }}

  <script src="{% static 'js/charts.js' %}" defer></script>
  <script src="{% static 'js/charts.js' %}" defer></script>
{% endblock %}

