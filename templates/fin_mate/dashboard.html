{% extends "base.html" %}
{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3">Dashboard</h1>
    <div class="d-flex gap-2">
      <form method="get" class="d-flex gap-2">
        <label>
          <input name="period" type="month" class="form-control form-control-sm" value="{{ period_str }}">
        </label>
        <button class="btn btn-outline-secondary btn-sm">Apply</button>
      </form>
      <a class="btn btn-primary btn-sm" href="{% url 'fin_mate:transaction-create' %}">Add transaction</a>
      <a class="btn btn-outline-primary btn-sm" href="{% url 'fin_mate:budget-create' %}">New budget</a>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'fin_mate:account-create' %}">New account</a>
    </div>
  </div>


  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted">Total balance ({{ base_currency }})</div>
          <div class="fs-4 fw-semibold">{{ total_balance }}</div>

        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted">Income ({{ period|date:"Y-m" }})</div>
          <div class="fs-4 fw-semibold text-success">{{ income }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted">Expenses ({{ period|date:"Y-m" }})</div>
          <div class="fs-4 fw-semibold text-danger">{{ expenses }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted">Net (inc − exp)</div>
          <div class="fs-4 fw-semibold">{{ net }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Accounts -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Accounts</span>
          <a class="btn btn-sm btn-primary" href="{% url 'fin_mate:account-create' %}">Add</a>
        </div>
        <div class="card-body p-0">
          <table class="table align-middle mb-0">
            <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Currency</th>
              <th class="text-end">Balance</th>
            </tr>
            </thead>
            <tbody>
            {% for a in accounts %}
              <tr>
                <td class="position-relative">
                  <span class="fw-semibold">{{ a.name }}</span>
                  <a class="stretched-link" href="{% url 'fin_mate:account-detail' a.pk %}"
                     aria-label="Open {{ a.name }}"></a>
                </td>
                <td>{{ a.get_type_display }}</td>
                <td>{{ a.currency }}</td>
                <td class="text-end">{{ a.annotated_balance }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted">No accounts yet.</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="card mt-3">
          <div class="card-header">Balances by account</div>
          <div class="card-body">
            <canvas id="chart_accounts" height="220"></canvas>
          </div>
        </div>

      </div>
    </div>

    <!-- Top categories -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">Top expense categories ({{ period|date:"Y-m" }})</div>
        <div class="card-body">
          {% if top_categories %}
            <canvas id="chart_top_expenses" height="250"></canvas>
          {% else %}
            <div class="text-muted">No expenses this month.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Budgets -->
    <div class="col-12">
      <div class="card h-100 mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Budgets ({{ period|date:"Y-m" }})</span>
          <a class="btn btn-sm btn-primary" href="{% url 'fin_mate:budget-create' %}">Add</a>
        </div>
        <div class="card-body p-0">
          <table class="table align-middle mb-0">
            <thead>
            <tr>
              <th>Category</th>
              <th>Limit</th>
              <th>Spent</th>
              <th>Progress</th>
              <th></th>
            </tr>
            </thead>
            <tbody>
            {% for b in budgets %}
              <tr>
                <td>{{ b.obj.category.name }}</td>
                <td>{{ b.obj.limit }}</td>
                <td>{{ b.spent }}</td>
                <td style="min-width: 220px;">
                  {% with p=b.progress|floatformat:0 %}
                    <div class="progress" role="progressbar" aria-valuenow="{{ p }}" aria-valuemin="0"
                         aria-valuemax="100">
                      <div class="progress-bar {% if p|add:'0' > 100 %}bg-danger{% else %}bg-success{% endif %}"
                           style="width: {{ p }}%">{{ p }}%
                      </div>
                    </div>
                  {% endwith %}
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{% url 'fin_mate:budget-detail' b.obj.pk %}">Open</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted">No budgets yet.</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Recent transactions -->
    <div class="col-12">
      <div class="card h-100 mt-3">
        <div class="card-header">Recent transactions</div>
        <div class="card-body p-0">
          <table class="table align-middle mb-0">
            <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Amount</th>
              <th>Account</th>
              <th>Category</th>
              <th></th>
            </tr>
            </thead>
            <tbody>
            {% for tx in recent %}
              <tr>
                <td>{{ tx.date|date:"Y-m-d" }}</td>
                <td>
                  {% if tx.type == 'INCOME' %}
                    <span class="badge text-bg-success">Income</span>
                  {% else %}
                    <span class="badge text-bg-danger">Expense</span>
                  {% endif %}
                </td>
                <td>{{ tx.amount }}</td>
                <td>{{ tx.account.name }}</td>
                <td>{{ tx.category.name }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{% url 'fin_mate:transaction-detail' tx.pk %}">Open</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted">No transactions yet.</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  {{ top_categories|json_script:"top-cats-data" }}
  <script>
      (function () {
          const el = document.getElementById("chart_top_expenses");
          const dataEl = document.getElementById("top-cats-data");
          if (!el || !dataEl) return;

          let rows = [];
          try {
              rows = JSON.parse(dataEl.textContent || "[]");
          } catch (_) {
              rows = [];
          }
          if (!rows.length) return;

          const labels = rows.map(r => r.name || "—");
          const values = rows.map(r => Number(r.total) || 0);
          const total = values.reduce((a, b) => a + b, 0) || 1;
          const MIN_PCT = 3;

          if (window.ChartDataLabels) {
              Chart.register(window.ChartDataLabels);
          }

          new Chart(el, {
              type: "doughnut",
              data: {labels, datasets: [{data: values}]},
              options: {
                  responsive: true,
                  cutout: "55%",
                  plugins: {
                      legend: {position: "bottom"},
                      tooltip: {
                          callbacks: {
                              label: (ctx) => {
                                  const v = ctx.parsed;
                                  const pct = Math.round(v / total * 100);
                                  return `${ctx.label}: ${v.toLocaleString()} (${pct}%)`;
                              }
                          }
                      },
                      datalabels: window.ChartDataLabels ? {
                          color: "#fff",
                          font: {weight: "600", size: 12},
                          formatter: (v, ctx) => {
                              const pct = Math.round((v / total) * 100);
                              if (pct < MIN_PCT) return "";
                              const name = ctx.chart.data.labels[ctx.dataIndex] || "";
                              return `${name}\n${pct}%`;
                          },
                          anchor: "center",
                          align: "center",
                          clamp: true
                      } : undefined
                  }
              }
          });
      })();
  </script>

  {{ accounts_chart|json_script:"accounts-chart-data" }}
  <script>
      (() => {
          const dataEl = document.getElementById("accounts-chart-data");
          const host = document.getElementById("chart_accounts");
          if (!host || !dataEl) return;
          const ac = JSON.parse(dataEl.textContent || "{}");
          if (!ac.labels || !ac.labels.length) return;

          const css = n => getComputedStyle(document.documentElement).getPropertyValue(n).trim();
          const textColor = css('--bs-body-color') || '#e2e8f0';
          const gridColor = css('--bs-border-color') || '#e2e8f0';
          const onBarColor = '#f8fafc';

          const makePalette = (n, startHue = 210) =>
              Array.from({length: n}, (_, i) => {
                  const h = (startHue + (360 / n) * i) % 360;
                  return {bg: `hsl(${h} 70% 52% / .75)`, br: `hsl(${h} 70% 45% / 1)`};
              });
          const pal = makePalette(ac.values.length);

          const percentLabel = {
              id: 'percentLabel',
              afterDatasetsDraw(chart) {
                  const {ctx} = chart, ds = chart.data.datasets[0], meta = chart.getDatasetMeta(0);
                  const sum = ds.data.reduce((a, b) => a + b, 0) || 1;
                  ctx.save();
                  ctx.fillStyle = textColor;
                  ctx.font = '12px system-ui,Segoe UI,Roboto,Inter,sans-serif';
                  meta.data.forEach((bar, i) => {
                      const v = ds.data[i], pct = Math.round(v / sum * 100);
                      const {x, y, base} = bar.getProps(['x', 'y', 'base'], true);
                      ctx.textAlign = 'left';
                      ctx.textBaseline = 'middle';
                      ctx.fillText(`${pct}%`, Math.max(x, base) + 8, y);
                  });
                  ctx.restore();
              }
          };

          const nf = new Intl.NumberFormat(undefined, {maximumFractionDigits: 0});

          new Chart(host.getContext('2d'), {
              type: 'bar',
              data: {
                  labels: ac.labels,
                  datasets: [{
                      data: ac.values,
                      backgroundColor: pal.map(p => p.bg),
                      borderColor: pal.map(p => p.br),
                      borderWidth: 1.5,
                      borderRadius: 10,
                      barPercentage: .75,
                      categoryPercentage: .8
                  }]
              },
              options: {
                  indexAxis: 'y',
                  maintainAspectRatio: false,
                  plugins: {
                      legend: {display: false},
                      tooltip: {
                          backgroundColor: 'rgba(0,0,0,.85)',
                          borderColor: gridColor, borderWidth: 1, padding: 10,
                          callbacks: {
                              label: (ctx) => {
                                  const v = ctx.parsed.x || 0;
                                  const pct = ac.total ? Math.round(v / ac.total * 100) : 0;
                                  return `${nf.format(v)} {{ base_currency }} — ${pct}%`;
                              }
                          }
                      },
                      datalabels: {
                          color: onBarColor,
                          formatter: (v) => nf.format(v),
                          anchor: 'center',
                          align: 'center',
                          clip: true,
                          font: {weight: 700},
                          textStrokeColor: 'rgba(0,0,0,.35)',
                          textStrokeWidth: 2
                      }
                  },
                  scales: {
                      x: {
                          ticks: {color: textColor, callback: v => nf.format(v) + " {{ base_currency }}"},
                          grid: {color: gridColor, drawTicks: false}
                      },
                      y: {ticks: {color: textColor}, grid: {display: false}}
                  }
              },
              plugins: [percentLabel]
          });
      })();
  </script>

{% endblock %}
